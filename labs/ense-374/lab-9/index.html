<!DOCTYPE html>
<!-- Top Navigation modified from CodingNepal - https://www.codingnepalweb.com/mega-menu-and-dropdown-menu-html-css/ -->
<!-- Side navigation modified from Sticky, Smooth, Active Nav by Chris Coyier https://codepen.io/chriscoyier/pen/qyELzd -->
<!-- Collabsibles from W3Schools https://www.w3schools.com/howto/howto_js_collapsible.asp -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> ENSE 374 Lab 9 </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> 
  <link rel="stylesheet" href="/assets/css/style.css?v=">
  <link rel="icon" type="image/svg+xml" href="/assets/svg/at.svg">
  <!-- for mathjax support -->

</head>
<body>
  <nav id="site">
    <div class="wrapper">
      <div class="logo"><a href="#"><img
        src="/assets/svg/at.svg" alt="logo" height="35" width="35" /></a></div>
      <input type="radio" name="slider" id="menu-btn">
      <input type="radio" name="slider" id="close-btn">
      <ul class="nav-links">
        <label for="close-btn" class="btn close-btn"><i class="fas fa-times"></i></label>
        <li><a href="#">Blog</a></li>
        <li>
          <a href="#" class="desktop-item">CV ‚ñæ</a>
          <input type="checkbox" id="showDrop">
          <label for="showDrop" class="mobile-item">CV ‚ñæ</label>
          <ul class="drop-menu">
            <li><a href="#">Technical</a></li>
            <li><a href="#">Academic</a></li>
          </ul>
        </li>
        <li>
          <a href="#" class="desktop-item">Laboratory ‚ñæ</a>
          <input type="checkbox" id="showMega">
          <label for="showMega" class="mobile-item">Laboratory ‚ñæ</label>
          <div class="mega-box">
            <div class="content">

              <div class="row">
                <header>ENSE 374</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-374/">Schedule</a></li>
                  <li><a href="/labs/ense-374/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-374/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-374/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-374/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-374/lab-5">Lab 5</a></li>
                  <li><a href="/labs/ense-374/lab-6">Lab 6</a></li>
                  <li><a href="/labs/ense-374/lab-7">Lab 7</a></li>
                  <li><a href="/labs/ense-374/lab-8">Lab 8</a></li>
                  <li><a href="/labs/ense-374/lab-9">Lab 9</a></li>
                </ul>
              </div>

              <div class="row">
                <header>ENSE 411</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-411/schedule">Schedule</a></li>
                  <li><a href="/labs/ense-411/lab-0">Lab 0</a></li>
                  <li><a href="/labs/ense-411/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-411/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-411/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-411/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-411/lab-5">Lab 5</a></li>
                </ul>
              </div>

              <div class="row">
                <header>ENSE 472</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-472/">Schedule</a></li>
                  <li><a href="/labs/ense-472/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-472/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-472/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-472/lab-4">Lab 4</a></li>
                  <!--li><a href="/labs/ense-472/lab-5">Lab 5</a></li-->
                </ul>
              </div>
            </div>
          </div>
        </li>
        <li><a href="javascript:void(0);" id="darklink">üåûÔ∏é</a></li>
      </ul>
      <label for="menu-btn" class="btn menu-btn"><i class="fas fa-bars"></i></label>
    </div>
  </nav>
  
  <div class="body">
    <nav id="toc-nav">
      <ul id="toc">

      </ul>
    </nav>

    <main id="content" class="main-content" role="main">
        <p></p>
        <h1 id="lab-9-passport">Lab 9: Passport</h1>

<p>ENSE 374 - Software Engineering Management - Laboratory</p>

<p>University of Regina - Engineering and Applied Science - Software Systems Engineering</p>

<p>Lab Instructor: <a href="mailto:Adam.Tilson@uregina.ca">Adam Tilson</a></p>

<hr />

<p><button class="expandall">Collapse All</button></p>
<section id="objective"><button class="collapsible">Objective</button><div class="text-content"><div class="text-inner">

      <p>This lab introduces Passport, which handles authentication using a number of different strategies. We will use the strategy of registering users in the MongoDB database using mongoose. Additionally, we will discuss other important security concepts such as storing environment variables securely.</p>

    </div></div></section>
<section id="equipment"><button class="collapsible">Equipment</button><div class="text-content"><div class="text-inner">

      <p>Computer running Windows, MacOS or Linux, with an Intel or AMD-based processor (x86 or x86-64) with administrator privileges.</p>
      <ul>
        <li>A modern web browser, with a strong preference for Firefox or Chrome</li>
        <li>A text editor, preferably VS Code</li>
      </ul>

    </div></div></section>
<section id="part1authenticationandsecurity"><button class="collapsible">Part 1: Authentication and Security</button><div class="text-content"><div class="text-inner">

      <h3 id="background">Background</h3>

      <p>So far our to-do list is functional, but not at all secure. How can we make it more secure?</p>
      <ul>
        <li>What‚Äôs wrong with what we‚Äôve done so far?</li>
        <li>What happens if you push passwords to github?</li>
        <li>What about storing them on the cloud?</li>
        <li>What if users use the same password as in other services?</li>
      </ul>

      <h3 id="encryption">Encryption</h3>

      <p>We can scramble our passwords using Encryption</p>
      <ul>
        <li>If you haven‚Äôt already, you‚Äôll learn all the math behind this later. (RSA)</li>
        <li>We can use the <code class="language-plaintext highlighter-rouge">mongoose-encryption</code> package <a href="https://www.npmjs.com/package/mongoose-encryption">available on NPM</a>
          <ul>
            <li>We need two Secret string - this is our encryption and decryption key. It should be kept secret!</li>
            <li>We then need to plug in the encryption to the schema</li>
          </ul>
        </li>
        <li>Automatically encrypts on a save and decrypts on a read</li>
        <li>Now our system is only as secure as our ‚Äúsecret‚Äù - which we don‚Äôt want to just push to github!
          <ul>
            <li>So how do we store our secret more‚Ä¶ secretly?</li>
          </ul>
        </li>
      </ul>

      <h3 id="environment-variables">Environment Variables</h3>

      <ul>
        <li>A hidden file which can stores our secrets in a safe location</li>
        <li>We can use this for our ‚ÄúAuthorization‚Äù key.
          <ul>
            <li>We could also use it for API keys.</li>
          </ul>
        </li>
      </ul>

      <p>From npm:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install dotenv
</code></pre></div>      </div>

      <p>In our js file:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">dotenv</span><span class="dl">"</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
</code></pre></div>      </div>

      <p>In our root directory:</p>

      <p>Create a <code class="language-plaintext highlighter-rouge">.env</code> file in the root.</p>
      <ul>
        <li>This is the whole name of the file
          <ul>
            <li>Similar to the <code class="language-plaintext highlighter-rouge">.gitignore</code> file</li>
          </ul>
        </li>
        <li>Save your variables here:</li>
      </ul>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_HOST=localhost
DB_USER=root
</code></pre></div>      </div>

      <p>No quotations for strings</p>

      <p>Access in variables in our node js file:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span>
</code></pre></div>      </div>

      <p>Finally, add this file to your gitignore!</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.env
</code></pre></div>      </div>

      <p>This will keep the file from getting pushed to the github.</p>

      <p>When you upload your files to the server, they will have a secure method for editing your apps Environment Variables.</p>

      <h3 id="salting-and-hashing">Salting and Hashing</h3>

      <p>Encrypting and Decrypting passwords has some flaws, it‚Äôs better to Hash!</p>

      <p>Hash functions are a mathematical equation which turns a string into a hash code</p>
      <ul>
        <li>Deterministic, so the same input always produces the same hash</li>
        <li>It‚Äôs impossible (or at least ridiculously hard) to go backwards (one-way function)</li>
      </ul>

      <p>Since we know going forward produces consistent results, thus we can ask for a password, hash it, and store the hashed value in our database. The next time the user enters the password, the entered password is hashed and checks with what‚Äôs in our database.</p>

      <p>Example: MD5 application</p>

      <p>If a website ever sends you a plain-text version of your password, you know that they aren‚Äôt hashing!</p>

      <p>How can we beat this?</p>
      <ul>
        <li>Make a hash table of common passwords, and compare.</li>
        <li>Modern GPUs can do 20Bill Hashes per Second!</li>
      </ul>

      <p>How else can we improve security?</p>

      <p>Use a slow hashing function, like bcrypt</p>
      <ul>
        <li>This will prevent how much brute forcing can be done</li>
      </ul>

      <p>Add a salt and then hash!</p>
      <ul>
        <li>generate a random string (Salt)
          <ul>
            <li>concatenate it to the password</li>
            <li>hash the whole thing!</li>
            <li>This will produce a different value than only hashing the password</li>
            <li>Save the salt into the database too for future reuse
              <ul>
                <li>When testing new use passwords, grab the old salt, concatenate it, and hash, then check</li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <p>More security? Salting rounds</p>
      <ul>
        <li>salt it, hash it, salt it, hash it,</li>
        <li>do it 5 times?</li>
      </ul>

      <p>You can set the number of rounds you want to salt</p>
      <ul>
        <li>adding one salt round doubles the time to compute it.</li>
      </ul>

      <p>Can we do this in node? sure!</p>

      <p><code class="language-plaintext highlighter-rouge">bcrypt</code> <a href="https://www.npmjs.com/package/bcrypt">Bcrypt on NPM</a></p>
      <ul>
        <li>you can hash, choose the number of salt rounds, etc.</li>
      </ul>

      <h3 id="cookies">Cookies</h3>

      <p>Cookies are a piece of data that is stored on the users browser
We are going to use it to store an ‚Äúaccess token‚Äù</p>
      <ul>
        <li>a hash which identifies which user is logged in.</li>
      </ul>

      <h3 id="sessions">Sessions</h3>

      <p>The amount of time that a browser interacts with a server</p>
      <ul>
        <li>Cookies let you maintain your session</li>
      </ul>

      <h3 id="open-authorization-oauth">Open Authorization (OAuth)</h3>

      <p>Beyond the scope of this lab but worth mentioning:</p>
      <ul>
        <li>OAuth is the cool new paradigm for authorization</li>
        <li>We essentially subcontract another company to do authorization for us
          <ul>
            <li>Google, FaceBook, GitHub, etc.</li>
            <li>The user logs in with their credentials for that account</li>
            <li>The third party verifies the users identity without exchanging any passwords. Cool!</li>
          </ul>
        </li>
        <li>This is possible to achieve using passport OAuth modules.</li>
      </ul>

    </div></div></section>
<section id="part2usageandexample"><button class="collapsible">Part 2: Usage and Example</button><div class="text-content"><div class="text-inner">

      <p>Let‚Äôs see how this application works by example. Let‚Äôs build on our Game Review submission application from last week.</p>

      <p>Recall we basically made it here, with some minor adjustments‚Ä¶:</p>

      <p>Set up the following directory structure:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|-- /views
|    |-- reviews.ejs
|    |-- add-review.ejs
|-- .env
|-- index.html
|-- add.js
</code></pre></div>      </div>

      <p>in <code class="language-plaintext highlighter-rouge">/views/reviews.ejs</code></p>
      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
    <span class="c">&lt;!-- Styles from w3Schools table tutorial --&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">table</span> <span class="p">{</span>
          <span class="nl">font-family</span><span class="p">:</span> <span class="n">arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
          <span class="nl">border-collapse</span><span class="p">:</span> <span class="nb">collapse</span><span class="p">;</span>
          <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nt">td</span><span class="o">,</span> <span class="nt">th</span> <span class="p">{</span>
          <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#dddddd</span><span class="p">;</span>
          <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
          <span class="nl">padding</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nt">tr</span><span class="nd">:nth-child</span><span class="o">(</span><span class="nt">even</span><span class="o">)</span> <span class="p">{</span>
          <span class="nl">background-color</span><span class="p">:</span> <span class="m">#dddddd</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>User Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Game Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Score<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Review Text<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
    <span class="c">&lt;!-- We want to repeat this for each game in the database --&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">for</span> <span class="err">(</span><span class="na">const</span> <span class="na">result</span> <span class="na">of</span> <span class="na">results</span><span class="err">)</span> <span class="err">{</span> <span class="err">%</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.userName</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.gameName</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.score</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.reviewText</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="err">}</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- End repeating bit --&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/add-review"</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add a Review!"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/logout"</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Log Out!"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>Let‚Äôs modify our <code class="language-plaintext highlighter-rouge">index.html</code> into <code class="language-plaintext highlighter-rouge">add-review.ejs</code></p>

      <p>in <code class="language-plaintext highlighter-rouge">/views/add-review.ejs</code></p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Add Reviews<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/submit"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"gameName"</span><span class="nt">&gt;</span>Game Name<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"gameName"</span> <span class="na">id=</span><span class="s">"gameName"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"score"</span><span class="nt">&gt;</span>Score<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"score"</span> <span class="na">id=</span><span class="s">"score"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"reviewText"</span><span class="nt">&gt;</span>Review Text<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"reviewText"</span> <span class="na">id=</span><span class="s">"reviewText"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>Let‚Äôs add a new register and sign up page, <code class="language-plaintext highlighter-rouge">index.html</code></p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Register or Log In<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-signin"</span> <span class="na">action=</span><span class="s">"/register"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Register<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputEmail"</span><span class="nt">&gt;</span>Email address<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">id=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Email address"</span> <span class="na">required</span> <span class="na">autofocus</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputPassword"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Password"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-lg btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-signin"</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputEmail"</span><span class="nt">&gt;</span>Email address<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">id=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Email address"</span> <span class="na">required</span> <span class="na">autofocus</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputPassword"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Password"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-lg btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>And finally, our <code class="language-plaintext highlighter-rouge">app.js</code></p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span> <span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span> <span class="p">);</span>

<span class="c1">// 1. Require dependencies /////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// this is a canonical alias to make your life easier, like jQuery to $.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span> 
<span class="c1">// a common localhost test port</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span> 

<span class="c1">// body-parser is now built into express!</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">(</span> <span class="p">{</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">)</span> <span class="p">);</span> 

<span class="c1">// 2. Create a session. The secret is used to sign the session ID.</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>


<span class="nx">app</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span> <span class="dl">"</span><span class="s2">view engine</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ejs</span><span class="dl">"</span> <span class="p">);</span>

<span class="c1">// connect to mongoose on port 27017</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="dl">'</span><span class="s1">mongodb://localhost:27017/games</span><span class="dl">'</span><span class="p">,</span> 
                 <span class="p">{</span> <span class="na">useNewUrlParser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">useUnifiedTopology</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="c1">// 3. Create the userSchema ////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="kd">const</span> <span class="nx">gameSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
    <span class="na">userName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">gameName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">score</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span>
    <span class="na">reviewText</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Game</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span> <span class="dl">"</span><span class="s2">Game</span><span class="dl">"</span><span class="p">,</span> <span class="nx">gameSchema</span> <span class="p">);</span>


<span class="c1">// 4. Add our strategy for using Passport, using the local user from MongoDB</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// Simple server operation</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span> <span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// template literal</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span> <span class="s2">`Server is running on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span> <span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 5. Register a user with the following code, which needs to be in the appropriate route</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 6. Log in users on the login route //////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the root route using get</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/index.html</span><span class="dl">"</span> <span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 7. Register get routes for reviews and add-review ///////////////</span>
<span class="c1">//Your code will replace this section!</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the reviews route using get, and found:</span><span class="dl">"</span> <span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">results</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">reviews</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">results</span> <span class="p">:</span> <span class="nx">results</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">error</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/add-review</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the add-review route using get</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">add-review</span><span class="dl">"</span> <span class="p">);</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 8. Logout ///////////////////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 9. Submit a post to the database ////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>And set up our requirements with:</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm init
npm i express ejs mongoose
</code></pre></div>      </div>

      <p>Make sure <code class="language-plaintext highlighter-rouge">mongod</code> is running!</p>

      <h3 id="required-packages">Required packages</h3>

      <p>We are going to install the following packages:</p>

      <ul>
        <li><code class="language-plaintext highlighter-rouge">passport</code> - An authentication middleware for express making use of different strategies</li>
        <li><code class="language-plaintext highlighter-rouge">passport-local</code> - A username and password authentication strategy</li>
        <li><code class="language-plaintext highlighter-rouge">passport-local-mongoose</code> - Simplifies using username/password with Mongo</li>
        <li><code class="language-plaintext highlighter-rouge">express-session</code> (not express-sessions) -Middleware for creating sessions.</li>
      </ul>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i passport passport-local passport-local-mongoose express-session dotenv
</code></pre></div>      </div>

      <p>Note: It‚Äôs very important to use these snippets in the order they are used in this example. I have thus included locations in the sample code for where to insert each bit by number!</p>

      <h3 id="add-needed-packages">Add needed packages:</h3>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Require dependencies /////////////////////////////////////////</span>
<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express-session</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">passportLocalMongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">passport-local-mongoose</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">dotenv</span><span class="dl">"</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>We don‚Äôt need  to directly user passport-local, so don‚Äôt need access to it through a const</p>

      <h3 id="set-up-the-dotenv-file">Set up the dotenv file</h3>

      <p>Create and add the following to the <code class="language-plaintext highlighter-rouge">/.env</code> file:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SECRET=Something secret to encrypt our session
</code></pre></div>      </div>

      <h3 id="use-session">Use session</h3>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 2. Create a session. The secret is used to sign the session ID.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
    <span class="na">secret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
    <span class="na">resave</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">saveUninitialized</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="create-the-userschema">Create the userSchema</h3>

      <p>We need to use a specific schema for passport-local-mongoose, make sure your fields are named as follows:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 3. Create the userSchema /////////////////////////////////////////</span>
<span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span> <span class="p">({</span>
    <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">})</span>

<span class="c1">// plugins extend Schema functionality</span>
<span class="nx">userSchema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">passportLocalMongoose</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="dl">"</span><span class="s2">User</span><span class="dl">"</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="set-our-passport-strategy">Set our Passport strategy:</h3>

      <p>This section creates the Passport strategy, and encodes our user into the session. 
passportLocalMongoose, which we plugged in earlier, is doing the heavy lifting for us.</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 4. Add our strategy for using Passport, using the local user from MongoDB</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">createStrategy</span><span class="p">());</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">());</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">());</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="register-users">Register users:</h3>

      <p>Add the following snippet to register users.</p>

      <p>Note the weird syntax on <code class="language-plaintext highlighter-rouge">passport.authenticate</code>. This is a higher-order function which returns a function, (i.e. a function factory,) the second set of args are passed to the returned function.</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 5. Register a user with the following code, which needs to be in the appropriate route</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/register</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is attempting to register</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span> <span class="na">username</span> <span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="p">},</span> 
                    <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> 
                    <span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">user</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/register</span><span class="dl">"</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span> <span class="p">)(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>Once signed in, we can get the username with:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
</code></pre></div>      </div>

      <h3 id="log-in-users">Log-in Users:</h3>

      <p>Logging in users is similar to registering users‚Ä¶</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 6. Log in users on the login route ////////////////////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is attempting to log in</span><span class="dl">"</span> <span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span> <span class="p">({</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">login</span> <span class="p">(</span> <span class="nx">user</span><span class="p">,</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span> <span class="p">)(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">);</span> 
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="allow-in-authenticated-users">Allow in authenticated users</h3>

      <p>Only users who are authenticated should be able to access the <code class="language-plaintext highlighter-rouge">reviews</code> page. Ditto for the <code class="language-plaintext highlighter-rouge">add-review</code> page</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 7. Register get routes for reviews and add-review ////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">A user is accessing the reviews route using get, and...</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">()</span> <span class="p">){</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was authorized and found:</span><span class="dl">"</span> <span class="p">);</span>
            <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">results</span> <span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">reviews</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">results</span> <span class="p">:</span> <span class="nx">results</span> <span class="p">});</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">error</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was not authorized.</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/add-review</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the add-review page, and...</span><span class="dl">"</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was authorized</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">add-review</span><span class="dl">"</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was not authorized</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">)</span> 
    <span class="p">}</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="log-out-users">Log-out Users:</h3>

      <p>We can log out users on the logout route with the following</p>
      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 8. Logout ///////////////////////////////////////////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/logout</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is logging out</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="using-the-session-when-posting-reviews">Using the session when posting reviews:</h3>

      <p>Finally, lets complete our application by by adding in the submit route:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 9. Submit a post to the database ////////////////////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/submit</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is adding the review:</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="p">)</span>
    <span class="kd">const</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">({</span>
        <span class="na">userName</span><span class="p">:</span>   <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">gameName</span><span class="p">:</span>   <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">gameName</span><span class="p">,</span>
        <span class="na">score</span><span class="p">:</span>      <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">score</span> <span class="p">),</span>
        <span class="na">reviewText</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">reviewText</span>
    <span class="p">});</span>

    <span class="nx">game</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">)</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>Note, when you restart your server (Which nodemon does frequently!) all of the cookies expire, so you will be logged out.</p>

    </div></div></section>
<section id="labassignment"><button class="collapsible">Lab Assignment:</button><div class="text-content"><div class="text-inner">

      <p>For the final big assignment, you will add complete database integration into the application from Lab 7. You finally have a stack which is ready for a production environment!</p>

      <h3 id="schema">Schema</h3>

      <p>Update you Schemas from Lab 8, if needed, to work with Passport / Mongoose</p>

      <h3 id="user-registration-and-login">User registration and login:</h3>

      <p>Modify the login page on the ‚Äú/‚Äù route.</p>

      <p>Link the login form to the ‚Äú/login‚Äù route with POST. In this route perform the following:</p>
      <ul>
        <li>Using passport, log in and authenticate the user</li>
        <li>If authentication fails, redirect back to ‚Äú/‚Äù</li>
        <li>If registration succeeds, redirect to ‚Äú/todo‚Äù</li>
      </ul>

      <p>Link the register form to the ‚Äú/register‚Äù route. In this route perform the following:</p>
      <ul>
        <li>Register a new user using passport</li>
        <li>If registration fails, redirect back to ‚Äú/‚Äù</li>
        <li>If registration succeed, redirect to ‚Äú/todo‚Äù</li>
        <li>The Authentication key, which is checked against when registering users, should be stored in the <code class="language-plaintext highlighter-rouge">.env</code> file!</li>
      </ul>

      <p><code class="language-plaintext highlighter-rouge">todo</code> should only be available to Authenticated users.</p>
      <ul>
        <li>As long as user is authenticated, they should be able to return to ‚Äú/todo‚Äù without logging in again, until the cookie expires or they log out.</li>
      </ul>

      <h3 id="to-do-list-display">To-do list display</h3>

      <p>Use EJS to render the to-do list on the <code class="language-plaintext highlighter-rouge">/todo</code> route</p>

      <ul>
        <li>
          <p>Modify your code from Lab 7 to instead read from the database.</p>
        </li>
        <li>
          <p>Reuse as much code as possible! The front-end should have minimal to no changes.</p>
        </li>
      </ul>

      <h3 id="to-do-list-functionality">To-do list functionality</h3>

      <p>Modify the code from Lab 7 to use the database.</p>
      <ul>
        <li>All of the same functionality should exist,
          <ul>
            <li>Now all operations should read and write to the database instead read from the database rather than the JSON file</li>
          </ul>
        </li>
      </ul>

      <h3 id="submission">Submission</h3>

      <p>Please submit to URCourses by the due date!</p>
    </div></div></section>

    </main>

  </div>
  <footer>
    2021 Adam Tilson.
    <a href="https://creativecommons.org/licenses/by-nc-sa/2.0/"
      >CC-BY-NC-SA</a
    >
  </footer>
  <button onclick="topFunction()" id="topButton" title="Go to top">‚ñ≤ Top</button> 
  <script src="/assets/js/script.js"></script>

</body>
</html>
