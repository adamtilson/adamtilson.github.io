<!DOCTYPE html>
<!-- Top Navigation modified from CodingNepal - https://www.codingnepalweb.com/mega-menu-and-dropdown-menu-html-css/ -->
<!-- Side navigation modified from Sticky, Smooth, Active Nav by Chris Coyier https://codepen.io/chriscoyier/pen/qyELzd -->
<!-- Collabsibles from W3Schools https://www.w3schools.com/howto/howto_js_collapsible.asp -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> ENSE 472 Lab 5 </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> 
  <link rel="stylesheet" href="/assets/css/style.css?v=">
  <link rel="icon" type="image/svg+xml" href="/assets/svg/at.svg">
  <!-- for mathjax support -->

</head>
<body>
  <nav id="site">
    <div class="wrapper">
      <div class="logo"><a href="#"><img
        src="/assets/svg/at.svg" alt="logo" height="35" width="35" /></a></div>
      <input type="radio" name="slider" id="menu-btn">
      <input type="radio" name="slider" id="close-btn">
      <ul class="nav-links">
        <label for="close-btn" class="btn close-btn"><i class="fas fa-times"></i></label>
        <!-- <li><a href="#">Blog</a></li>
        <li>
          <a href="#" class="desktop-item">CV ▾</a>
          <input type="checkbox" id="showDrop">
          <label for="showDrop" class="mobile-item">CV ▾</label>
          <ul class="drop-menu">
            <li><a href="#">Technical</a></li>
            <li><a href="#">Academic</a></li>
          </ul>
        </li> -->
        <li>
          <a href="#" class="desktop-item">Laboratory ▾</a>
          <input type="checkbox" id="showMega">
          <label for="showMega" class="mobile-item">Laboratory ▾</label>
          <div class="mega-box">
            <div class="content">


              <div class="row">
                <header>ENSE 271</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-271/">Schedule</a></li>
                  <li><a href="/labs/ense-271/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-271/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-271/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-271/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-271/lab-5">Lab 5</a></li>
                  <li><a href="/labs/ense-271/lab-6">Lab 6</a></li>
                  <!-- <li><a href="/labs/ense-271/lab-7">Lab 7</a></li> -->
                </ul>
              </div>

              <!-- <div class="row">
                <header>ENSE 374</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-374/">Schedule</a></li>
                  <li><a href="/labs/ense-374/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-374/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-374/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-374/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-374/lab-5">Lab 5</a></li>
                  <li><a href="/labs/ense-374/lab-6">Lab 6</a></li>
                  <li><a href="/labs/ense-374/lab-7">Lab 7</a></li>
                  <li><a href="/labs/ense-374/lab-8">Lab 8</a></li>
                  <li><a href="/labs/ense-374/lab-9">Lab 9</a></li>
                </ul>
              </div> -->

              <!-- <div class="row">
                <header>ENSE 411</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-411/schedule">Schedule</a></li>
                  <li><a href="/labs/ense-411/lab-0">Lab 0</a></li>
                  <li><a href="/labs/ense-411/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-411/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-411/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-411/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-411/lab-5">Lab 5</a></li>
                </ul>
              </div> -->

              <!-- <div class="row">
                <header>ENSE 472</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-472/">Schedule</a></li>
                  <li><a href="/labs/ense-472/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-472/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-472/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-472/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-472/lab-5">Lab 5</a></li>
                </ul>
              </div> -->
            </div>
          </div>
        </li>
        <li><a href="javascript:void(0);" id="darklink">🌞︎</a></li>
      </ul>
      <label for="menu-btn" class="btn menu-btn"><i class="fas fa-bars"></i></label>
    </div>
  </nav>
  
  <div class="body">
    <nav id="toc-nav">
      <ul id="toc">

      </ul>
    </nav>

    <main id="content" class="main-content" role="main">
        <p></p>
        <h1 id="lab-5-network-application-programming---godot-multiplayer">Lab 5: Network Application Programming - Godot Multiplayer</h1>

<p>ENSE 472 - Digital Networks - Laboratory</p>

<p>University of Regina - Engineering and Applied Science - Software Systems Engineering</p>

<p>Lab Instructor: <a href="mailto:Adam.Tilson@uregina.ca">Adam Tilson</a></p>

<hr />

<p><button class="expandall">Collapse All</button></p>
<section id="objective"><button class="collapsible">Objective</button><div class="text-content"><div class="text-inner">

      <p>The purpose of this lab is to see how to code a the network interactivity for an application. This will introduce important concepts in network application such as:</p>
      <ul>
        <li>Network application architectures, such as peer-to-peer and client/server</li>
        <li>Remote procedure calls</li>
        <li>Reliable vs. unreliable data transmission, and the pros and cons of each</li>
        <li>And sending unexpected data</li>
      </ul>

      <p>In particular, we will create a multiplayer game using the Godot Game Engine, a MIT-licensed, cross-platform free and open-source game engine great for rapid prototyping due to user friendly features such as the python-like GDScript, built in patterns and features such as singletons (AutoLoads), observers (signals), groups and a high-level network interface. We will look at a simple 2D battle game ready for multiplayer integration.</p>

    </div></div></section>
<section id="equipment"><button class="collapsible">Equipment</button><div class="text-content"><div class="text-inner">

      <p>A Windows, Mac or Linux computer. The Godot game engine runs as a standalone executable on any operating system, and integrates the engine and IDE in a single application.</p>

    </div></div></section>
<section id="part1godotoverview"><button class="collapsible">Part 1: Godot Overview</button><div class="text-content"><div class="text-inner">

      <p>To get started, download the latest version of Godot. We are currently on version 3.5.1 (Nov 2022.)</p>

      <p><img src="res/dl-godot-1.png" alt="" />
<img src="res/dl-godot-2.png" alt="" />
<img src="res/new-project.png" alt="" />
<img src="res/create-folder.png" alt="" /></p>

      <p>Unzip, and run the executable. This is the entire game engine, IDE, everything in a single program. Cool!</p>
      <ul>
        <li>On MAC you may need to give Godot permissions to run in your system settings</li>
        <li>Leave the console window open, if you close it godot will close!</li>
      </ul>

      <p><img src="res/ui.png" alt="" /></p>

      <p>The UI of Godot is surprisingly dense, which every area being very useful, though it may not be apparent for what right away.</p>
      <ol>
        <li>The File Menu
          <ul>
            <li>Standard things like saving, exporting, setting preferences</li>
            <li><code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Export</code> is useful for making binaries (but you need to download export templates first!)</li>
            <li>In particular, <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Project Settings</code> is very important for setting the main scene, setting up AutoLoads, setting controls, etc.</li>
          </ul>
        </li>
        <li>The Scene Tree
          <ul>
            <li>This is where you compose the current scene of nodes</li>
          </ul>
        </li>
        <li>FileSystem
          <ul>
            <li>This is where you can see the assets imported into the current project</li>
          </ul>
        </li>
        <li>Switch between 2D/3D/Code/Asset Library
          <ul>
            <li>The 2D view is used for 2D games and UI</li>
            <li>The 3D view for 3D games</li>
            <li>Script for writing GDScript</li>
            <li>AssetLib for downloading community creations</li>
          </ul>
        </li>
        <li>Center Stage - Drag around elements, or Code
          <ul>
            <li>This is where you arrange elements, or code,</li>
          </ul>
        </li>
        <li>Output, Debugger, Audio and Animation
          <ul>
            <li>When debugging code, you’ll see important stuff down here</li>
            <li>Also useful when animating</li>
          </ul>
        </li>
        <li>Play and Switch GL Mode
          <ul>
            <li>This is where you can demo your project or scene</li>
          </ul>
        </li>
        <li>Inspector and Node
          <ul>
            <li>This is where you can set properties of the selected node</li>
            <li>You can also attach and modify resources here</li>
            <li>Additionally, you can attach signals in the <code class="language-plaintext highlighter-rouge">Node</code> menu</li>
          </ul>
        </li>
      </ol>

      <p>Once you switch into script mode, the coding interface replaces center stage:</p>

      <p><img src="res/coding.png" alt="" /></p>

      <h3 id="overview-and-help">Overview and Help</h3>

      <ul>
        <li>An overview of the Godot Engine</li>
      </ul>

      <p><a href="https://docs.godotengine.org/en/stable/index.html">The official godot docs</a></p>

      <h3 id="scenes-and-nodes">Scenes and Nodes</h3>

      <p>The fundamental building blocks of the Godot engine are Nodes</p>
      <ul>
        <li>Equivalent to classes</li>
        <li>The engine has many of these already created for you
          <ul>
            <li>e.g. <code class="language-plaintext highlighter-rouge">Node2D</code> is a simple container which exists in 2D space
              <ul>
                <li><code class="language-plaintext highlighter-rouge">Node2D</code> has a number of properties you can set, either from the Inspector or Code, such as Position (Vector2D)</li>
                <li>All 2D classes will be subclassed from Node2D, inheriting properties and methods
                  <ul>
                    <li>A Sprite is a subclass of Node2D, meaning, it will inherit the position property, but will also have its own</li>
                  </ul>
                </li>
                <li><code class="language-plaintext highlighter-rouge">Node2D</code> has an array of <code class="language-plaintext highlighter-rouge">children</code> which are of type <code class="language-plaintext highlighter-rouge">Node2D</code>, allowing of any type
                  <ul>
                    <li>Because all nodes inherit from Node2D, all nodes support composition</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <p>Some nodes need resources to be created and attached to have complete functionality, such as Sprites or Materials</p>
        </li>
        <li>You can search for the predefined types by attempting to add one to the game tree
          <ul>
            <li>You can read more about the types in docs</li>
          </ul>
        </li>
        <li>You can subclass nodes to create your own nodes by adding a script
          <ul>
            <li>This allows you to extend the functionality through code</li>
          </ul>
        </li>
        <li>Your custom node trees can be saved as a Scene (<code class="language-plaintext highlighter-rouge">.tscn</code> file) and re-used
          <ul>
            <li>This is similar to prototyping in other languages</li>
          </ul>
        </li>
      </ul>

      <p>Example: A simple physics example</p>
      <ul>
        <li>Ensure you are in 2D mode</li>
        <li>Add a root <code class="language-plaintext highlighter-rouge">Node2D</code> by selecting 2D scene</li>
      </ul>

      <p><img src="res/root-node.png" alt="" /></p>

      <ul>
        <li>Add a StaticBody2D</li>
      </ul>

      <p><img src="res/add-static-body.png" alt="" /></p>

      <ul>
        <li>Attach a Sprite to the StaticBody2D</li>
      </ul>

      <p><img src="res/add-sprite.png" alt="" /></p>

      <ul>
        <li>Some nodes need resources ro function properly.</li>
        <li>Load in a sprite resource, using the default Godot icon PNG</li>
      </ul>

      <p><img src="res/add-sprite-png.png" alt="" /></p>

      <ul>
        <li>
          <p>Attach it a CollisionShape2D to the StaticBody2D</p>

          <p><img src="res/add-collision-shape.png" alt="" /></p>

          <ul>
            <li>Give it a collision shape resource</li>
            <li>This will be the boundaries for collisions</li>
          </ul>

          <p><img src="res/shape-resource.png" alt="" /></p>

          <ul>
            <li>
              <p>Resize the collision shape extents to match the sprite</p>

              <p><img src="res/resize-collision.png" alt="" /></p>
            </li>
          </ul>
        </li>
        <li>Follow the same process with a RigidBody2D
          <ul>
            <li>Attach a Sprite
              <ul>
                <li>Load in a sprite resource, using the default PNG</li>
              </ul>
            </li>
            <li>Attach it a CollisionShape2D
              <ul>
                <li>Give it a collision shape resource
                  <ul>
                    <li>Resize the collision shape extents to match the sprite</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Group together the StaticBody and its children so they move together
          <ul>
            <li>
              <p>Do the same with the RigidBody</p>

              <p><img src="res/group-together.png" alt="" /></p>
            </li>
          </ul>
        </li>
        <li>Move the RigidBody2D on top of the StaticBody2D
          <ul>
            <li>Play (Save scene as <code class="language-plaintext highlighter-rouge">demo.tscn</code>!)</li>
            <li>
              <p>You may wish to set it as the default scene too!</p>

              <p><img src="res/preview.png" alt="" /></p>
            </li>
          </ul>
        </li>
        <li>
          <p>If it is falling too slowly, you can increase the mass of the object in <code class="language-plaintext highlighter-rouge">Scene</code> -&gt; <code class="language-plaintext highlighter-rouge">RigidBody2D</code> -&gt; <code class="language-plaintext highlighter-rouge">Inspector</code> -&gt; <code class="language-plaintext highlighter-rouge">RigidBody2D</code> -&gt; <code class="language-plaintext highlighter-rouge">Gravity Scale</code>. Maybe 3 or 4 is okay?</p>
        </li>
        <li>Duplicate a few of the RigidBody2Ds and move them around and rotate
          <ul>
            <li>Ctrl D, and use these tools for positioning</li>
          </ul>
        </li>
        <li>Make the static body bigger to catch them
          <ul>
            <li>
              <p>Play again! Neat</p>

              <p><img src="res/rearranged.png" alt="" /></p>
            </li>
          </ul>
        </li>
      </ul>

      <p><a href="https://docs.godotengine.org/en/stable/getting_started/step_by_step/scenes_and_nodes.html">Getting started with nodes</a></p>

      <h3 id="gd-script">GD Script</h3>

      <p>The default scripting language used in Godot is GDScript.</p>
      <ul>
        <li>The syntax of this language is very similar to python</li>
        <li>Let’s use code to “jump” one of our RigidBodies when “Space” is pressed.</li>
      </ul>

      <p>First attach a script to the RigidBody</p>

      <p><img src="res/attach-script.png" alt="" /></p>

      <p>Attached scripts are akin to classes, so we should give it an appropriate name:</p>

      <p><img src="res/jumping-box.png" alt="" /></p>

      <p>This is GDSCript. It is similar to Python.</p>

      <p>Note that our class extends RigidBody2D. This is because we attached it to a RigidBody2D. Through inheritance, we can use any of the properties and methods available in that class.</p>

      <p>The two main entry points are the _ready, and _process functions, which are automatically invoked by the engine when the object is created (<code class="language-plaintext highlighter-rouge">_ready</code>) and every frame the object lives (<code class="language-plaintext highlighter-rouge">_process(delta)</code>). We are going to add another function called <code class="language-plaintext highlighter-rouge">_physics_process(delta)</code>. This is similar to process, but is called each time the physics engine updates.</p>

      <p>To see which parts of the RigidBody we can access, <a href="https://docs.godotengine.org/en/stable/classes/class_rigidbody2d.html">check out the docs</a></p>

      <p>We’ll directly apply a</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extends</span> <span class="n">RigidBody2D</span>

<span class="n">func</span> <span class="n">_physics_process</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">Input</span><span class="p">.</span><span class="n">is_action_just_pressed</span><span class="p">(</span><span class="s">"ui_accept"</span><span class="p">):</span>
		<span class="n">linear_velocity</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>Note, these controller buttons can be customized from <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Project Settings</code> -&gt; <code class="language-plaintext highlighter-rouge">Input Map</code>
Also note that Vector2’s are coordinate pairs corresponding to x,y pairs, where the origin is in the top left of the screen.</p>

      <p><a href="https://docs.godotengine.org/en/stable/getting_started/scripting/gdscript/gdscript_basics.html">GDScript Basics</a></p>

      <h3 id="signals">Signals</h3>

      <p>In Godot, Signals implement the observer pattern</p>

      <ul>
        <li>You can find signals attached to certain objects, which are observable states</li>
        <li>You can wire them up to scripts so that, when that signal is called, you can handle that event</li>
        <li>This is also similar to event systems with callback
          <ul>
            <li>These are found in <code class="language-plaintext highlighter-rouge">Node Pane</code> -&gt; <code class="language-plaintext highlighter-rouge">Signals</code></li>
            <li>Let’s wire the <code class="language-plaintext highlighter-rouge">body_entered</code> signal on the RigidBody2D to itself:</li>
          </ul>
        </li>
        <li>Let’s use a signal to detect when the RigidBody collides with the floor, and when it does, bounce it back up:</li>
      </ul>

      <p><img src="res/wiring-signal.png" alt="" /></p>

      <p>Let’s add some code too:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># make sure the name matches the name generated when connecting the signal!
</span><span class="n">func</span> <span class="n">_on_RigidBody2D4_body_entered</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="n">StaticBody2D</span><span class="p">:</span>
		<span class="n">apply_impulse</span><span class="p">(</span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">))</span>
</code></pre></div>      </div>

      <p>Finally, we need to configure the RigidBody2D to report collisions, since it does not by default:</p>

      <p><img src="res/contacts-report.png" alt="" /></p>

      <p><a href="https://docs.godotengine.org/en/stable/getting_started/step_by_step/signals.html">Signals</a></p>

      <h3 id="custom-scenes">Custom Scenes</h3>

      <p>We’ve done a lot of configuration work on the RigidBody2D. We should break it into it’s own scene for reuse:</p>

      <p><code class="language-plaintext highlighter-rouge">Right Click</code> -&gt; <code class="language-plaintext highlighter-rouge">Save Branch as Scene</code></p>
      <ul>
        <li>Save it as <code class="language-plaintext highlighter-rouge">JumpingBox.tscn</code></li>
        <li>Remove the other instances of RigidBody2Ds, and replace them with JumpingBoxes</li>
      </ul>

      <p>With the combination of the scene and the script, this now acts as a self-contained class!</p>

      <p><img src="res/adding-custom-scenes.png" alt="" /></p>

      <p>Cool, now all of our boxes are jumping!</p>

      <h3 id="groups">Groups</h3>

      <p>What if we had several different static bodies, and we wanted to bounce on them all?
We could put them in a group to easily find them:</p>

      <p><img src="res/add-to-group.png" alt="" /></p>

      <p>Now we can modify our code to only work for the group.</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">func</span> <span class="n">_on_RigidBody2D4_body_entered</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
	<span class="n">var</span> <span class="n">floors</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">().</span><span class="n">get_nodes_in_group</span><span class="p">(</span><span class="s">"floors"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">floors</span><span class="p">:</span>
		<span class="n">apply_impulse</span><span class="p">(</span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">))</span>
</code></pre></div>      </div>

      <p>This would be useful if we had other StaticBodies, for example, walls</p>

      <p><a href="https://docs.godotengine.org/en/latest/tutorials/scripting/groups.html">Groups</a></p>

      <h3 id="autoloads">AutoLoads</h3>

      <p><code class="language-plaintext highlighter-rouge">AutoLoads</code> are scripts which are loaded at the time the game is instantiated. There is thus one globally accessible reference. This is an implementation of the Singleton design pattern.</p>

      <p>We can access the AutoLoads from the menu <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Project Settings</code> -&gt; <code class="language-plaintext highlighter-rouge">AutoLoad</code></p>

      <p>Let’s create an AutoLoad script for spawning blocks at regular intervals:</p>

      <p>Create a new GDScript <code class="language-plaintext highlighter-rouge">Spawner.gd</code>, and add in:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extends</span> <span class="n">Node</span>

<span class="n">var</span> <span class="n">timer</span>
<span class="n">var</span> <span class="n">spawn_interval</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">var</span> <span class="n">jumping_box_scene</span> <span class="o">=</span> <span class="n">preload</span><span class="p">(</span><span class="s">"res://JumpingBox.tscn"</span><span class="p">)</span>

<span class="n">func</span> <span class="n">_ready</span><span class="p">():</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">set_wait_time</span><span class="p">(</span><span class="n">spawn_interval</span><span class="p">)</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">set_one_shot</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"timeout"</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s">"_on_timer_timeout"</span><span class="p">)</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">set_autostart</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
	<span class="n">add_child</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>

<span class="n">func</span> <span class="n">_on_timer_timeout</span><span class="p">():</span>
	<span class="n">var</span> <span class="n">y</span> <span class="o">=</span> <span class="n">rand_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>
	<span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">rand_range</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>
	<span class="n">var</span> <span class="n">new_block</span> <span class="o">=</span> <span class="n">jumping_box_scene</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
	<span class="n">new_block</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
	<span class="n">get_tree</span><span class="p">().</span><span class="n">get_root</span><span class="p">().</span><span class="n">add_child</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>And attach the script like</p>

      <p><img src="res/add-autoload.png" alt="" /></p>

      <p>You could stop the time from any script like:</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var Spawner = get_node("/root/Spawner")
Spawner.timer.stop()
</code></pre></div>      </div>

      <p>Of if you prefer, you can add PlayerVariables directly to the local namespace by <code class="language-plaintext highlighter-rouge">Enabling</code> the singleton.</p>

      <p><a href="https://docs.godotengine.org/en/stable/getting_started/step_by_step/singletons_autoload.html">Singletons (AutoLoad)</a></p>

    </div></div></section>
<section id="part2projectsetup"><button class="collapsible">Part 2: Project Setup</button><div class="text-content"><div class="text-inner">

      <h3 id="the-game-offline-phase-1">The Game Offline (Phase 1)</h3>

      <p>The Game we are going to add network multiplayer to is as follows:</p>

      <p>Goal:</p>
      <ul>
        <li>Stomp on other players to gain a point
          <ul>
            <li>When you stomp on a player they respawn</li>
          </ul>
        </li>
        <li>If you fall off the stage you lose a point</li>
      </ul>

      <p>Controls:</p>
      <ul>
        <li>Arrow Keys or WASD to move</li>
        <li>Jump (Up when on the ground)</li>
        <li>Ground Pound (Down when in air)</li>
        <li>Air Dash (Double tap right or left when in air)</li>
        <li>Drop though floors (Double tap down when on a drop-through floor)</li>
        <li>Wall Jumps (Up while pressing into a wall)</li>
      </ul>

      <p>Find the starter code on URCourses…</p>
      <ul>
        <li>Note that it is in 3 phases, before multiplayer, with Lobby support but no extras, and with completed.</li>
      </ul>

      <p>A brief walk through the classes:</p>

      <p>GameLogic (<code class="language-plaintext highlighter-rouge">GameLogic.gd</code>)</p>
      <ul>
        <li>Instantiates players in the <code class="language-plaintext highlighter-rouge">_ready</code> function</li>
        <li>Handles scoring</li>
        <li>Awards points</li>
        <li><em>Important</em> we are manually creating our players right now. We’re going to be having the Network API do it for us later on!</li>
      </ul>

      <p>Spawner (<code class="language-plaintext highlighter-rouge">Spawner.gd</code>, <code class="language-plaintext highlighter-rouge">Spawner.tscn</code>)</p>
      <ul>
        <li>Locations in the game where players will spawn</li>
        <li>Spawners have a cool-down which prevents respawning a player in an area too quickly</li>
        <li>Additionally, spawners all added to the group <code class="language-plaintext highlighter-rouge">spawners</code>.</li>
      </ul>

      <p>Player (<code class="language-plaintext highlighter-rouge">Player.gd</code>, <code class="language-plaintext highlighter-rouge">Player.tscn</code>)</p>
      <ul>
        <li>A monster class</li>
        <li>Handles player movement</li>
        <li>Also handles respawning players</li>
        <li>Also handles score</li>
      </ul>

      <p>OneWayWall (<code class="language-plaintext highlighter-rouge">OneWalWall.gd</code>, <code class="language-plaintext highlighter-rouge">OneWayWall.tscn</code>)</p>

      <ul>
        <li>Identifies walls which the player can drop through</li>
      </ul>

      <p>BattleField (<code class="language-plaintext highlighter-rouge">BattleField.tscn</code>)</p>

      <ul>
        <li>The default arena for the game, composed of other objects</li>
      </ul>

      <p>Based on this, what do you believe you would need to send over the network to make this game run?</p>

    </div></div></section>
<section id="part3lowlevelmultiplayer"><button class="collapsible">Part 3: Low-Level Multiplayer</button><div class="text-content"><div class="text-inner">

      <p>Godot supports low-level multiplayer</p>
      <ul>
        <li>This basically allows one to establish a connection over TCP
          <ul>
            <li>And then send packets</li>
          </ul>
        </li>
        <li>You can also send packets over UDP</li>
        <li>These are raw data - you can send whatever you want
          <ul>
            <li>That means the server listening on the other end can be in any language, e.g. Python</li>
            <li>The server can perform error checking, and ensure no data tampering has occurred</li>
          </ul>
        </li>
        <li>
          <p>However this is much harder that what we’ll work with</p>
        </li>
        <li>Recall from our investigation of TCP in earlier labs that TCP has significant overhead. This can lead to slower performance overall.
          <ul>
            <li>Also, recall how UDP packets were faster, but delivery was not guaranteed.
              <ul>
                <li>This too can be not great for games</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Instead, we need something a hybrid - we need the speed of UDP and the reliability of TCP
          <ul>
            <li>For example, developers might code their own protocol, on top of UDP, for guaranteeing delivery, e.g. with custom ACKs.</li>
            <li>One example of this is to handle simple synchronizing operations with UDP, such as player movement, but more sophisticated operations which require reliable delivery with TCP</li>
          </ul>
        </li>
      </ul>

      <p>For this course, we will instead look at the high level multiplayer, which is such a system built into the Godot engine.</p>

    </div></div></section>
<section id="part4highlevelmultiplayer"><button class="collapsible">Part 4: High-Level Multiplayer</button><div class="text-content"><div class="text-inner">

      <p>High level multiplayer concepts</p>

      <h3 id="lets-all-go-to-the-lobby-phase-2">(Let’s all go to) The Lobby (Phase 2)</h3>

      <p>The first part of most multiplayer games is a lobby where we manage connections</p>
      <ul>
        <li>If you are a client, you need to specify which IP to connect to</li>
        <li>Recall <code class="language-plaintext highlighter-rouge">127.0.0.1</code> is the loopback address, also known as localhost, meaning connect to the local device</li>
      </ul>

      <p>My lobby has been borrowed from the <a href="https://godotengine.org/asset-library/asset/139">Bomberman-style Multiplayer Example</a></p>

      <ul>
        <li>Modifications from Phase 1:
          <ul>
            <li>Added <code class="language-plaintext highlighter-rouge">lobby.gd</code>
              <ul>
                <li>This make heavy use of UI and signals</li>
                <li>In particular, the <code class="language-plaintext highlighter-rouge">$</code> is a shortcut to find nodes</li>
                <li>e.g. <code class="language-plaintext highlighter-rouge">$Connect.hide()</code> is finding the part of the UI named Connect, and hiding it.</li>
              </ul>
            </li>
            <li>Added <code class="language-plaintext highlighter-rouge">lobby.tscn</code></li>
            <li>Added <code class="language-plaintext highlighter-rouge">gamestate.gd</code> (AutoLoad)
              <ul>
                <li>Migrated all of the spawning code from <code class="language-plaintext highlighter-rouge">GameLogic.gd</code> into <code class="language-plaintext highlighter-rouge">gamestate.gd</code></li>
                <li>This was to stay consistent with the Tutorial</li>
              </ul>
            </li>
            <li>Change <code class="language-plaintext highlighter-rouge">lobby.tscn</code> to the main scene to load
              <ul>
                <li>This is done in <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Project Settings</code> -&gt; <code class="language-plaintext highlighter-rouge">General</code> -&gt; <code class="language-plaintext highlighter-rouge">Application</code> -&gt; <code class="language-plaintext highlighter-rouge">Run</code> -&gt; <code class="language-plaintext highlighter-rouge">Main Scene</code></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <p>Important - when players are created, they are given unique network id’s in the <code class="language-plaintext highlighter-rouge">gamestate.gd</code></p>
      <ul>
        <li>It is most important that you look through: <code class="language-plaintext highlighter-rouge">gamestate</code> -&gt; <code class="language-plaintext highlighter-rouge">pre_start_game</code> so you can understand how players are instantiated and added to the tree.</li>
        <li>Each player gets a unique player ID. In particular, the Host always gets <code class="language-plaintext highlighter-rouge">p_id = 1</code>. Every other player gets a large random int.</li>
      </ul>

      <p>Right now we have two unique instances of the game which have the ability to to communicate between them, but they are not sharing all of the data needed to synchronize gameplay. We need to figure out how to make that communication such that each instance can only control their player, and the game state gets updated appropriately.</p>

      <h4 id="testing-multiple-instances">Testing Multiple Instances</h4>

      <p>During testing, if you need to run a second instance of the game, you can copy the Godot Engine (.exe) into the project directory, and then run it from there, which will autoload the game. Efficient!</p>

      <h3 id="design-for-network-application">Design for Network Application</h3>

      <p><a href="https://docs.godotengine.org/en/stable/tutorials/networking/high_level_multiplayer.html">Godot High Level Multiplayer</a></p>

      <p>The purpose of our application is to have the Game State synchronized between the players</p>
      <ul>
        <li>Most importantly is the score, as this determines the winner</li>
        <li>But also, in order for players to see where the other players are, and dodge them, their position needs to be updated too
          <ul>
            <li>Consider if we only synchronize position?</li>
            <li>Consider if we synchronize both position and velocity?
              <ul>
                <li>This leads to an important concept - <code class="language-plaintext highlighter-rouge">prediction</code>
                  <ul>
                    <li>If we are given gaps in information, can we fill in the bits we don’t using the physics engine?</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <p>Finally, we also need to handle movement?</p>
        </li>
        <li>Which game instance should be in charge of which players?
          <ul>
            <li>We will implement it such that each game instance is in charge of it’s own player’s movement.
              <ul>
                <li>I am the one true source of knowledge on my location
                  <ul>
                    <li>Everyone else is just observing</li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>Players could also be in charge of when they are defeated
              <ul>
                <li>This leads to another important concept - security and tampering - which we’ll investigate in the assignment</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Each time a game state is synchronized, a message is passed getween game instances. Which ones are the most important? Which ones can we occasionally miss?</li>
      </ul>

      <p>Together these considerations point to three important concepts to consider are: performance, reliability and security.</p>

      <h3 id="technical-implementation-details-in-godot">Technical implementation details in Godot:</h3>

      <p>In our app, <code class="language-plaintext highlighter-rouge">Lobby</code> runs first and manages connections
Next, gamestate creates the <code class="language-plaintext highlighter-rouge">Player</code> class, one per connected peer per game</p>
      <ul>
        <li>So if two players are playing, each player game has two copies of the Player class
          <ul>
            <li>Four total Player classes across two games!</li>
          </ul>
        </li>
        <li>GameA is in control of PlayerA, GameB is in control of PlayerB
          <ul>
            <li>The copy of PlayerB in GameA is just a puppet, observing the state of PlayerB in GameB</li>
            <li>Ditto for PlayerA in GameB</li>
          </ul>
        </li>
      </ul>

      <p><img src="res/master-of-puppets.png" alt="" /></p>

      <p><code class="language-plaintext highlighter-rouge">rpc</code> functions are Remote Procedure Calls. They call a function on other devices, assuming those devices have permission.</p>
      <ul>
        <li>Permission are given by keywords before the function:
          <ul>
            <li><code class="language-plaintext highlighter-rouge">remote</code> - the function is only called from a remote peer</li>
            <li><code class="language-plaintext highlighter-rouge">remotesync</code> - the function is called remotely and locally</li>
            <li><code class="language-plaintext highlighter-rouge">master</code> - a delegated network master has the ability to call this function</li>
            <li><code class="language-plaintext highlighter-rouge">puppet</code> - non-network masters will instead use this function</li>
          </ul>
        </li>
        <li><code class="language-plaintext highlighter-rouge">rpc</code>s have <code class="language-plaintext highlighter-rouge">reliable</code> (default) and <code class="language-plaintext highlighter-rouge">unreliable</code> variants
          <ul>
            <li>We can call an RCP on just one instance with <code class="language-plaintext highlighter-rouge">rpc_id</code>. The default <code class="language-plaintext highlighter-rouge">rpc</code> calls it on all instances.</li>
          </ul>
        </li>
      </ul>

      <p><code class="language-plaintext highlighter-rouge">rset</code> is how to remotely synchronize a variable</p>
      <ul>
        <li>as with <code class="language-plaintext highlighter-rouge">rpc</code>, there are reliable and unreliable versions</li>
        <li><code class="language-plaintext highlighter-rouge">master</code> / <code class="language-plaintext highlighter-rouge">puppet</code> make sense in this context, for example, as a player you are the <code class="language-plaintext highlighter-rouge">master</code> of your location. The copy of your player appearing in everyone else’s game is merely a <code class="language-plaintext highlighter-rouge">puppet</code>.</li>
      </ul>

    </div></div></section>
<section id="part5peertopeerapplication"><button class="collapsible">Part 5:Peer-to-peer Application</button><div class="text-content"><div class="text-inner">

      <p>To add network functionality to our application, we must make the following changes:</p>

      <ol>
        <li>Make sure each player controls their character, and only their character
          <ul>
            <li>In the player script, modify the value of the <code class="language-plaintext highlighter-rouge">is_controllable</code> bool to <code class="language-plaintext highlighter-rouge">is_network_master()</code>
              <ul>
                <li>This will automatically make a player controllable only if they are the player associated with that game instance</li>
                <li>e.g. PlayerA in GameA, PlayerB in GameB</li>
              </ul>
            </li>
          </ul>
          <ul>
            <li>You need to also remove setting controllable from in <code class="language-plaintext highlighter-rouge">gamestate.gd</code></li>
          </ul>
        </li>
      </ol>

      <p>On line 26:</p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">var</span> <span class="n">is_master</span>            <span class="o">=</span> <span class="n">false</span>
</code></pre></div>      </div>

      <p>On line 32, inside the _ready function:</p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">is_master</span> <span class="o">=</span> <span class="n">is_network_master</span><span class="p">()</span>
</code></pre></div>      </div>

      <ol>
        <li>Modify player position and velocity to be a synchronized variable
          <ul>
            <li>In particular, you will want to create a puppet position and puppet velocity in addition to the true ones</li>
            <li>And update them using the <code class="language-plaintext highlighter-rouge">rset</code> or <code class="language-plaintext highlighter-rouge">rset_unreliable</code> functions</li>
          </ul>
        </li>
      </ol>

      <p>In the class variables, at the top:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">puppet</span> <span class="n">var</span> <span class="n">puppet_position</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">()</span>
<span class="n">puppet</span> <span class="n">var</span> <span class="n">puppet_velocity</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>And, when controlling the player, update these variables and add an <code class="language-plaintext highlighter-rouge">else</code> case to the player movement, on line 80:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="n">rset_unreliable</span><span class="p">(</span><span class="s">"puppet_position"</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
		<span class="n">rset_unreliable</span><span class="p">(</span><span class="s">"puppet_velocity"</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span>
	
	<span class="k">else</span><span class="p">:</span>
		<span class="n">position</span> <span class="o">=</span> <span class="n">puppet_position</span>
		<span class="n">velocity</span> <span class="o">=</span> <span class="n">puppet_velocity</span>
</code></pre></div>      </div>

      <p>What would happen if we only tracked <code class="language-plaintext highlighter-rouge">position</code> instead of both <code class="language-plaintext highlighter-rouge">position</code> and <code class="language-plaintext highlighter-rouge">velocity</code>?</p>

      <ol>
        <li>Ensure that award_point is a synchronized function. Ditto with decrement score.
          <ul>
            <li>This ensures that it gets called on all clients</li>
          </ul>
        </li>
      </ol>

      <p>change the function from:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">func</span> <span class="n">award_point</span> <span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="n">loser</span><span class="p">):</span>
</code></pre></div>      </div>

      <p>to</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remotesync</span> <span class="n">func</span> <span class="n">award_point</span> <span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="n">loser</span><span class="p">):</span>
</code></pre></div>      </div>

      <p>And make sure it is called correctly, around line 198, update the following call:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>			<span class="n">award_point</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>to</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>			<span class="n">rpc</span><span class="p">(</span><span class="s">"award_point"</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>      </div>

      <ol>
        <li>
          <p>Perform similar updates for decrementing score. The function is defined around 144, and called on 212. Can you figure out how to update it? Do we need to pass any arguments?</p>
        </li>
        <li>
          <p>In the go_to_timeout() function, ensure that it only runs if you are the network master</p>
          <ul>
            <li>All others will simply do nothing.</li>
            <li>Position will thus be handled by it being a synchronized variable</li>
            <li>We should also make sure the score decrements as an RPC!</li>
          </ul>
        </li>
      </ol>

      <p>The stage three code, included has this functionality implemented. You may start your assignment from Stage 3.</p>

    </div></div></section>
<section id="labassignment"><button class="collapsible">Lab Assignment</button><div class="text-content"><div class="text-inner">

      <p>There are two parts to this lab assignment.</p>

      <p>In part 1, you are to modify the game so that, rather than being implemented as peer-to-peer application, it is instead a dedicated client-server architecture</p>
      <ul>
        <li>This means that the server could be deployed to the cloud and run without any human interaction
          <ul>
            <li>In other words, the server, aka the host, does not have a character in the game.
              <ul>
                <li>Instead it merely acts as an intermediary lobby between the clients.</li>
              </ul>
            </li>
            <li>Maintain all other aspects of functionality - do not change any data structures.
              <ul>
                <li>It should work with clients from Phase 3 with minimal changes (simple not spawning a player with network id 1)</li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <p>Procedure:</p>

      <ul>
        <li>Make two copies of the code from Phase 3</li>
        <li>Rename one into <code class="language-plaintext highlighter-rouge">client</code></li>
        <li>Rename the other into <code class="language-plaintext highlighter-rouge">server</code></li>
        <li>Modify the client and server code such that there is no player assigned to the host.
          <ul>
            <li>Hint: Where are the players instanced? Which id is assigned to the host?</li>
            <li>The host should automatically be waiting for players mode when no game is playing, and return there when a game ends</li>
            <li>You may wish to see how the <code class="language-plaintext highlighter-rouge">lobby</code> works, and skip the first screen altogether
              <ul>
                <li>Once all of the players have joined, a player will need to manually start the game</li>
              </ul>
            </li>
            <li>No person should not need to interact with the server instance directly, it could theoretically run on a headless system.
              <ul>
                <li>However, the client will still show the game in progress visually</li>
              </ul>
            </li>
            <li>The client should no longer be able to host, and should instead just connect to the server.</li>
          </ul>
        </li>
        <li>Don’t overthink this - the changes are on the order of 10 lines of code!</li>
      </ul>

      <p>Server (right) is waiting for the clients to join (left):
<img src="res/server-waiting.png" alt="" /></p>

      <p>Players join and server awaiting start:
<img src="res/server-await-start.png" alt="" /></p>

      <p>Server (right) displays the game world, but does not have a player in the game:
<img src="res/server-observes.png" alt="" /></p>

      <p>When a player disconnects, the server returns to waiting for new players. Other players are kicked out too:
<img src="res/back-to-waiting.png" alt="" /></p>

      <p>In part 2, make a third version of the project called <code class="language-plaintext highlighter-rouge">cheat-client</code>, which is a version of the client which cheats in some way.</p>
      <ul>
        <li>The cheats should work with the server logic, i.e. not cause a crash</li>
        <li>Think about what the player is in control of, vs. what the server is in control of.</li>
        <li>As we are not validating legal data, these should go undetected by the server, and give some advantage in the game.</li>
        <li>Your cheat client should not crash the server!</li>
      </ul>

      <p>I was planning to mark this lab through a live demo, where you connect to my server and demonstrate your application. However, as this is our last scheduled lab session, we will instead do submission via URCourses. Please zip up your project for all three phases (<code class="language-plaintext highlighter-rouge">server</code>, <code class="language-plaintext highlighter-rouge">client</code> and <code class="language-plaintext highlighter-rouge">cheat-client</code>). Include a readme file which explains your cheat-client’s functionality.</p>

    </div></div></section>
<section id="references"><button class="collapsible">References</button><div class="text-content"><div class="text-inner">

      <p>J. Linietsky, A. Manzur, Godot Community, <a href="https://docs.godotengine.org/en/stable/index.html">The Godot Docs!</a>, [Online]</p>

      <p>BornCG, <a href="https://www.youtube.com/watch?v=HvPTSZl2WCc">Let’s Build a 2D Platformer!: Part 1</a>. YouTube.com. Apr 6 2020. [Online]</p>
    </div></div></section>

    </main>

  </div>
  <footer>
    2022 Adam Tilson.
    <a href="https://creativecommons.org/licenses/by-nc-sa/2.0/"
      >CC-BY-NC-SA</a
    >
  </footer>
  <button onclick="topFunction()" id="topButton" title="Go to top">▲ Top</button> 
  <script src="/assets/js/script.js"></script>

</body>
</html>
