<!DOCTYPE html>
<!-- Top Navigation modified from CodingNepal - https://www.codingnepalweb.com/mega-menu-and-dropdown-menu-html-css/ -->
<!-- Side navigation modified from Sticky, Smooth, Active Nav by Chris Coyier https://codepen.io/chriscoyier/pen/qyELzd -->
<!-- Collabsibles from W3Schools https://www.w3schools.com/howto/howto_js_collapsible.asp -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> ENSE 472 Lab 1 </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> 
  <link rel="stylesheet" href="/assets/css/style.css?v=">
  <link rel="icon" type="image/svg+xml" href="/assets/svg/at.svg">
  <!-- for mathjax support -->

</head>
<body>
  <nav id="site">
    <div class="wrapper">
      <div class="logo"><a href="#"><img
        src="/assets/svg/at.svg" alt="logo" height="35" width="35" /></a></div>
      <input type="radio" name="slider" id="menu-btn">
      <input type="radio" name="slider" id="close-btn">
      <ul class="nav-links">
        <label for="close-btn" class="btn close-btn"><i class="fas fa-times"></i></label>
        <!-- <li><a href="#">Blog</a></li>
        <li>
          <a href="#" class="desktop-item">CV ‚ñæ</a>
          <input type="checkbox" id="showDrop">
          <label for="showDrop" class="mobile-item">CV ‚ñæ</label>
          <ul class="drop-menu">
            <li><a href="#">Technical</a></li>
            <li><a href="#">Academic</a></li>
          </ul>
        </li> -->
        <li>
          <a href="#" class="desktop-item">Laboratory ‚ñæ</a>
          <input type="checkbox" id="showMega">
          <label for="showMega" class="mobile-item">Laboratory ‚ñæ</label>
          <div class="mega-box">
            <div class="content">


              <div class="row">
                <header>ENSE 271</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-271/">Schedule</a></li>
                  <li><a href="/labs/ense-271/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-271/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-271/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-271/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-271/lab-5">Lab 5</a></li>
                  <li><a href="/labs/ense-271/lab-6">Lab 6</a></li>
                  <!-- <li><a href="/labs/ense-271/lab-7">Lab 7</a></li> -->
                </ul>
              </div>

              <!-- <div class="row">
                <header>ENSE 374</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-374/">Schedule</a></li>
                  <li><a href="/labs/ense-374/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-374/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-374/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-374/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-374/lab-5">Lab 5</a></li>
                  <li><a href="/labs/ense-374/lab-6">Lab 6</a></li>
                  <li><a href="/labs/ense-374/lab-7">Lab 7</a></li>
                  <li><a href="/labs/ense-374/lab-8">Lab 8</a></li>
                  <li><a href="/labs/ense-374/lab-9">Lab 9</a></li>
                </ul>
              </div> -->

              <!-- <div class="row">
                <header>ENSE 411</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-411/schedule">Schedule</a></li>
                  <li><a href="/labs/ense-411/lab-0">Lab 0</a></li>
                  <li><a href="/labs/ense-411/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-411/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-411/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-411/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-411/lab-5">Lab 5</a></li>
                </ul>
              </div> -->

              <!-- <div class="row">
                <header>ENSE 472</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-472/">Schedule</a></li>
                  <li><a href="/labs/ense-472/lab-1">Lab 1</a></li>
                  <li><a href="/labs/ense-472/lab-2">Lab 2</a></li>
                  <li><a href="/labs/ense-472/lab-3">Lab 3</a></li>
                  <li><a href="/labs/ense-472/lab-4">Lab 4</a></li>
                  <li><a href="/labs/ense-472/lab-5">Lab 5</a></li>
                </ul>
              </div> -->
            </div>
          </div>
        </li>
        <li><a href="javascript:void(0);" id="darklink">üåûÔ∏é</a></li>
      </ul>
      <label for="menu-btn" class="btn menu-btn"><i class="fas fa-bars"></i></label>
    </div>
  </nav>
  
  <div class="body">
    <nav id="toc-nav">
      <ul id="toc">

      </ul>
    </nav>

    <main id="content" class="main-content" role="main">
        <p></p>
        <h1 id="lab-1-introduction-to-packet-tracer">Lab 1: Introduction to Packet Tracer</h1>

<p>ENSE 472 - Digital Networks - Laboratory</p>

<p>University of Regina - Engineering and Applied Science - Software Systems Engineering</p>

<p>Lab Instructor: <a href="mailto:Adam.Tilson@uregina.ca">Adam Tilson</a></p>

<hr />

<p><button class="expandall">Collapse All</button></p>
<section id="objective"><button class="collapsible">Objective</button><div class="text-content"><div class="text-inner">

      <p>The purpose of this lab is to:</p>

      <ul>
        <li>Have a quick primer on creating and running python scripts</li>
        <li>Understand inter-process communication</li>
        <li>Understand client-server architecture</li>
        <li>Understand protocols</li>
        <li>Low level vs. high level APIs</li>
        <li>Understand sockets</li>
        <li>Understanding asynchronous servers and threading</li>
      </ul>

    </div></div></section>
<section id="equipment"><button class="collapsible">Equipment</button><div class="text-content"><div class="text-inner">

      <p>Computer running Windows, MacOS or Linux, with an Intel or AMD-based processor (x86 or x86-64) with administrator privileges</p>
      <ul>
        <li>In this lab we will be working in Python 3. You will need it installed, which it already is on the lab machines.</li>
      </ul>

    </div></div></section>
<section id="introduction"><button class="collapsible">Introduction</button><div class="text-content"><div class="text-inner">

      <p>In this lab, we will investigate network programming by creating a simple chat application in Python. To begin, we will look at sockets, low level code, which is more similar to c or c++ interfaces on Unix, though a bit easier to work with. We will examine how network communication works from a top-down approach, starting with the programs, and then moving through the different layers of the network stack, as is needed to understand the problem.</p>

      <p>A common issue with network programming is that when there are bugs, it is difficult to assess if it is a programming error or a network error. For this reason, a thorough understanding of the entire network stack is required for Software Systems Engineers.</p>

    </div></div></section>
<section id="part1quickprimeronpython"><button class="collapsible">Part 1: Quick Primer on Python</button><div class="text-content"><div class="text-inner">

      <p>This lab requires a quick overview of the Python programming language. We will work through the exercises included in <code class="language-plaintext highlighter-rouge">ense-472-lab-1-warmup.py</code> to give you a quick overview of the programming language. To run the script, ensure you have Python 3 installed, open a terminal into the corresponding window, then type one of the following:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ense-472-lab-1-warmup.py
</code></pre></div>      </div>

      <p>Depending on your installation settings, the command you need to run may differ, (e.g. <code class="language-plaintext highlighter-rouge">py</code>, <code class="language-plaintext highlighter-rouge">py3</code>). When starting a python terminal, ensure the first line prints <code class="language-plaintext highlighter-rouge">python 3</code>. You can also ensure you are on python 3 by using <code class="language-plaintext highlighter-rouge">python --version</code> which should list 3.X.X. I will be doing these exercises on python 3.10.X.</p>

      <p>Note: if you have already taken ENSE 350, you will recall we used Jupyter Notebook for running python. That will not be approapraite for our network programming, as we will often be running servers which will need to run continuously in a single terminal window.</p>

    </div></div></section>
<section id="part2networkingbasicsreview"><button class="collapsible">Part 2: Networking Basics Review</button><div class="text-content"><div class="text-inner">

      <p>Network programming is essentially inter-process communication, where one program that you create interacts with another program you (or someone else) created. These programs may be running on the same device, or may be running across the world. Typically, interprocess communication on the same device occurs through multiple threads and shared memory, however, running them across multiple devices will require a more complex approach. This is a complex challenge, and the current solution makes use of a complete and complex software system - the internet.</p>

      <p>There are a number of concepts that are worth reviewing to help with this lab:</p>

      <h3 id="client">Client</h3>

      <p>The client is the device (or application) which initiates a request, which will be handled by a server. These are often (but not always) initiated directly by a user issuing a command.</p>

      <p>e.g. a web browser, a time-lookup client (ntp), a dns-lookup client</p>

      <h3 id="server">Server</h3>

      <p>The server is the device (or application) which responds to requests made by clients. It is typically running all the time, and may run as a service in the background (i.e. a daemon). A client will initiate communication with server, and based on the selected protocol, send and/or recieve data from the server.</p>

      <p>e.g. a web server, a dns server (bind), a time server, a game server</p>

      <p>As single client may connect to a single server:</p>

      <p><img src="res/one-client-one-server.png" alt="" /></p>

      <p>Or, multiple clients may connect to a single server:</p>

      <p><img src="res/one-server-mutliple-clients.png" alt="" /></p>

      <p>Additionally, the server and client applications may be running on the same physical device, though this is not required:</p>

      <p><img src="res/server-client-same-device.png" alt="" /></p>

      <p>Finally, note that a single application may act as a server, or a client, or both, however a single thread will typically only be acting as one or the other!</p>

      <p>One of the reasons that a client server model is useful is that it minimizes the total number of connections.</p>

      <p><img src="res/client-server-vs-clients-only.png" alt="" /></p>

      <p>Consider a first person shooter game with 100 players. In a client-server model, we would only need 100 connections - each client to the server. However, if instead we wanted every player to connect to every other player, we would need 99 connections for the first player + 98 more connections for the second player + 97 more connections for the third player, etc‚Ä¶ This would be a much more complex system!</p>

      <h3 id="address">Address</h3>

      <p>An address is a way to uniquely identify which device is initiating a request. There are several different addressing systems: public ipv4, private ipv4, ipv6, MAC, with different benefits and use cases. The simplest network configuration is two devices on a Local Area Network (LAN), with each having a different IP address. Packets will be sent along ethernet, and accepted only by the host with the matching IP address</p>

      <p><img src="res/two-devices-on-a-local-network.png" alt="" /></p>

      <p>However, there are also more complex setups, such as a Wide Area Network (WAN) such as the internet, in which a connected series of routers will send packets across multiple networks, and eventually deliver the packet to its destination.</p>

      <p><img src="res/two-devices-on-a-wan.png" alt="" /></p>

      <p>Regardless of the complexity of the network, proper addressing and proper network configuration can reliably deliver packets to their destination.</p>

      <p>For now, we will be running multiple clients and a server on the same device. We can access the device we are on using the localhost or loopback address <code class="language-plaintext highlighter-rouge">127.0.0.1</code>.</p>

      <h3 id="port">Port</h3>

      <p>A port is a number which represents a connection on a device which may be used by a single application. A device has 65,535 total ports. By convention, some of these ports are allocated to particular services, e.g. 80 HTTP, 22 SSH, and 443 HTTPS. However, there are other ports which do not have associated services, and are safe to use for your applications. Typically these start above 1024. Because a port uniquely identifies an application, once a packet is recieved, the computer will then be able to know which program in particular is looking for that information.</p>

      <p>e.g. on a server, an HTTPS web server will operate on port 443
e.g. on a client, Firefox may be running 6 different tabs on port 52197, 52198, 52199, 52200, 52205.</p>
      <ul>
        <li>When the first tab requests a web page, it will query the server (e.g. 142.196.3.7:443), and the returned address will be delivered back to the correct tab (e.g. 123.4.50.67:55657).
          <ul>
            <li>This is important, otherwise, the returned information (a recipe for cookies) may get delived to the wrong tab (your youtube video on network programming) and thus interrupt your stream!</li>
          </ul>
        </li>
      </ul>

      <p><img src="res/client-talking-to-server-over-port.png" alt="" /></p>

      <p>You may think of addresses like a street adress for an apartment, and a port like a suite number. Together we both learn which device we wish to reach, as well as which application.</p>

      <p><img src="res/client-talking-to-server-with-host-ips.png" alt="" /></p>

      <h3 id="protocols">Protocols</h3>

      <p>Protocols are the set of rules that dictate how devices on a network will interact with each other. For example, the TCP protocol favours reliability, wheras the UDP protocol favours speed. Depending on the protocol, a single transmitted message (‚ÄúHello World‚Äù), represented as bytes, may be broken up into a number of different packets, and even include some packets which are purely control information such as confirmations.</p>

      <p>e.g. a very simple protocol we will create will tell the server the length of the message using a fixed number of bytes, followed by delivering the actual message using a variable number of bytes:</p>

      <p><img src="res/message-length-message-protocol.png" alt="" /></p>

      <h3 id="socket">Socket</h3>

      <p>A socket is a bi-directional communication endpoint. Each of the two applications which wish to connect will create a socket, and connect to the other application‚Äôs socket. To create the socket we will need an IP Address, a Port and a Protocol. Once the socket has been established, the two devices may send data back and forth between the appliations.</p>

      <p>Here is an example of different socket operations in python:</p>

      <p><img src="res/socket-operations-in-python.png" alt="" /></p>

      <h3 id="packet">Packet</h3>

      <p>To make network communication more efficient, data may be split into smaller chunks, called packets. We will investigate this further in following labs.</p>

      <h3 id="thread">Thread</h3>

      <p>A thread is the smallest part of a program which can run independantly. We can think of this as a single function which will be created and run independantly until it is completed. The advantage of threads is that their execution and scheduling is handled by the operating system to ensure that the system remains responsive, and so that other threads can finish in a timely manner. It is very advantageous to run server applications as threads, so that each request may be handled by an independant thread.</p>

      <p>The trickiest part of threads is when data is shared between threads - as we cannot ensure the order in which lines of code execute in threads, this can lead to a race condition in some situations, with unpredictable results.</p>

      <p>Consider a simple variable <code class="language-plaintext highlighter-rouge">num_clients</code> which counts the total number of connected clients, and the following two sequences of operation.</p>

      <p>e.g. variable <code class="language-plaintext highlighter-rouge">num_clients</code> is shared by two threads <code class="language-plaintext highlighter-rouge">client_a_handler</code> and <code class="language-plaintext highlighter-rouge">client_b_handler</code>.</p>

      <p>Happy case:</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 0</code></p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (0)</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 1</code></p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (2)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (2)</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 2</code></p>

      <p>Race condition:</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 0</code></p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (0)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (0)</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 1</code></p>

      <p>We can avoid this using a <code class="language-plaintext highlighter-rouge">lock</code>, or similar mechanisms like a semaphore. This will prevent the second thread from reading the variable until the first thread is done with it.</p>

      <p>With semaphores:</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 0</code></p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (0) and locks it</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> can‚Äôt, it‚Äôs locked, try again later.</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (1)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> can‚Äôt, it‚Äôs locked, try again later.</p>

      <p><code class="language-plaintext highlighter-rouge">client_a_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (1) and unlocks it.</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> reads <code class="language-plaintext highlighter-rouge">num_clients</code> (1) and locks it.</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> increments <code class="language-plaintext highlighter-rouge">num_clients</code> (2)</p>

      <p><code class="language-plaintext highlighter-rouge">client_b_handler</code> writes <code class="language-plaintext highlighter-rouge">num_clients</code> (2) and unlocks it.</p>

      <p><code class="language-plaintext highlighter-rouge">num_clients = 2</code></p>

      <p>Finally, it is sometimes important for your main thread to broadcast a message to each of your sub-threads. We can accomplish this using thread events (signals).</p>

      <h3 id="encoding">Encoding</h3>

      <p>Encoding and Decoding is the process of turning a string into a series of bytes. There are a number of different methods for this, such as ASCII or Unicode. ASCII uses only one byte per character, which is very efficient, whereas Unicode (UTF-8) requires one to four bytes per character, which python uses by default.</p>

    </div></div></section>
<section id="part3lowlevelnetworkinginpython"><button class="collapsible">Part 3: Low-level Networking in Python</button><div class="text-content"><div class="text-inner">

      <p>In this section of the lab, we will look at some examples of low level networking using the <code class="language-plaintext highlighter-rouge">socket</code> library. In low-level networking, you have complete control over every byte sent and recieved over the network. (Outside of overhead)</p>

      <p>Let‚Äôs first look at an example of a client-only application which recieves time data from a centeral server. This is an example of the daytime service, which is used for network debugging:</p>

      <p><code class="language-plaintext highlighter-rouge">time_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the socket library contains low-level network operations
</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="c1"># when creating a socket class (from the socket library), we need to describe the address type (AF_INET is IPv4), and the socket type. 
</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="c1"># Where we want to connect and on what port
</span><span class="n">host</span> <span class="o">=</span> <span class="s">"time.nist.gov"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">13</span> <span class="c1">#default port for daytime service
# open the connection
</span><span class="n">sock</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># recieve up to 1024 bytes of data
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># daytime service uses ascii
</span>        <span class="n">data_as_string</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">data_as_string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
<span class="c1"># when finished with your sockets, it is important to close them
</span><span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>What if, on the other hand, we wanted to be the time-server? That‚Äôs a bit more complicated.</p>

      <p>Let‚Äôs first create a simple python program which prints the current time to the screen.</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">now_formatted</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%A, %B %d %Y, %H:%M:%S"</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="n">now_formatted</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>Not exactly the same format as the remote timeserver, but this is compliant with <a href="https://datatracker.ietf.org/doc/html/rfc867">RFC867</a></p>

      <p>Okay, now we just need to take this code, and host it inside a server:</p>

      <p><code class="language-plaintext highlighter-rouge">time_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># create a socket object
</span><span class="n">serversocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> 

<span class="c1"># get local machine name
</span><span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>                           

<span class="n">port</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># bind to the port
</span><span class="n">serversocket</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

<span class="n">serversocket</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>                                  

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># establish a connection
</span>    <span class="n">clientsocket</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">serversocket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>      

    <span class="k">print</span><span class="p">(</span><span class="s">"Got a connection from %s"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now_formatted</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%A, %B %d %Y, %H:%M:%S"</span><span class="p">)</span>
    <span class="n">now_bytes</span> <span class="o">=</span> <span class="n">now_formatted</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
    <span class="n">clientsocket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">now_bytes</span><span class="p">)</span>
    <span class="n">clientsocket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>Try running this code - nothing happens. But a server is running. Let‚Äôs try to connect to it, by modifying our time client such that:</p>

      <p><code class="language-plaintext highlighter-rouge">time_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the socket library contains low-level network operations
</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="c1"># when creating a socket class (from the socket library), we need to describe the address type (AF_INET is IPv4), and the socket type. 
</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="c1"># Now we want to connect to our own computer!
</span><span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="c1"># open the connection
</span><span class="n">sock</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># recieve up to 1024 bytes of data
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data_as_string</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">data_as_string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
<span class="c1"># when finished with your sockets, it is important to close them
</span><span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>However, it is much better if we handle each connection in an individual thread:</p>

      <p>Let‚Äôs look at how threading works in the next section.</p>

    </div></div></section>
<section id="part4threadingexampleinpython"><button class="collapsible">Part 4: Threading Example in Python</button><div class="text-content"><div class="text-inner">

      <p>Recall threads are the mechanism in python that allows you to split a program into small, parallel components. These components then run in parallel, as handled by the CPU. Here is a very simple example of a thread:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">print_cube</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"Cube: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">num</span> <span class="o">*</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">print_square</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"Square:"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">num</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
	<span class="c1"># creating thread
</span>	<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">print_square</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">print_cube</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>

	<span class="c1"># starting thread 1
</span>	<span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
	<span class="c1"># starting thread 2
</span>	<span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

	<span class="c1"># wait until thread 1 is complete
</span>	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
	<span class="c1"># wait until thread 2 is complete
</span>	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

	<span class="c1"># both threads are done
</span>	<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>Try running this program several times and watch to the order. Do they always finish in the same order?</p>

      <p>Let‚Äôs try this instead - instead of returning only the square or cube of the number, let‚Äôs count all the way up to the number:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">print_cubes_up_to</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"Cube: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">print_squares_up_to</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"Square:"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
	<span class="c1"># creating thread
</span>	<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">print_squares_up_to</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">print_cubes_up_to</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>

	<span class="c1"># starting thread 1
</span>	<span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
	<span class="c1"># starting thread 2
</span>	<span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

	<span class="c1"># wait until thread 1 is complete
</span>	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
	<span class="c1"># wait until thread 2 is complete
</span>	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

	<span class="c1"># both threads are done
</span>	<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>On my machine, it occasionally finishes out of order:</p>

      <p><img src="res/threads-order.png" alt="" /></p>

      <p>Another example which is worth exploring is that of shared variables and race conditions. Look at the following code:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>

<span class="c1"># global variable x
</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increment</span><span class="p">():</span>
    <span class="s">"""
    function to increment global variable x
    """</span>
    <span class="k">global</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">thread_task</span><span class="p">():</span>
    <span class="s">"""
    task for thread
    calls increment function 100000 times.
    """</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">):</span>
        <span class="n">increment</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main_task</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">x</span>
    <span class="c1"># setting global variable x as 0
</span>    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># creating threads
</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_task</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_task</span><span class="p">)</span>

    <span class="c1"># start threads
</span>    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait until threads finish their job
</span>    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">main_task</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> : x = </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>Run this code a few times. You should see not all iterations always add up to 20000. This is because a race condition occured, as mentioned in the introduction.</p>

      <p><img src="res/race.png" alt="" /></p>

      <p>We can avoid this by creating a locking mechanism, which we will pass to each of the threads:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>

<span class="c1"># global variable x
</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
    <span class="s">"""
    function to increment global variable x
    """</span>
    <span class="c1"># thread must wait here for the lock to be open
</span>    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="c1"># once in here, the lock is locked
</span>        <span class="k">global</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># once we finish this block, we'll unlock the lock again
</span>
<span class="k">def</span> <span class="nf">thread_task</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
    <span class="s">"""
    task for thread
    calls increment function 100000 times.
    """</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">):</span>
        <span class="n">increment</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main_task</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">x</span>
    <span class="c1"># setting global variable x as 0
</span>    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># create a lock
</span>    <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="c1"># creating threads
</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span>

    <span class="c1"># start threads
</span>    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait until threads finish their job
</span>    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">main_task</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Iteration {0}: x = {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>

</code></pre></div>      </div>

      <p>Try running it again - no more race conditions!</p>

      <p><img src="res/no-more-race-condition.png" alt="" /></p>

      <p>With servers, we will have code which spawns a new thread which runs in an infinite loop. We will need to be able to send that code a shutdown signal to stop. Let‚Äôs see an example of that:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">timed_output</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">server_active</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">server_active</span><span class="p">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: New Message!"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">server_active</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">server_active</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>

    <span class="n">delay1</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">timed_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">"bob"</span><span class="p">,</span> <span class="n">delay1</span><span class="p">,</span> <span class="n">server_active</span><span class="p">))</span>

    <span class="n">delay2</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">timed_output</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">"paul"</span><span class="p">,</span> <span class="n">delay2</span><span class="p">,</span> <span class="n">server_active</span><span class="p">))</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(.</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"attempting to close threads."</span><span class="p">)</span>
        <span class="n">server_active</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"threads successfully closed"</span><span class="p">)</span>
</code></pre></div>      </div>

    </div></div></section>
<section id="part5asimplethreadedechoclient"><button class="collapsible">Part 5: A Simple Threaded Echo Client</button><div class="text-content"><div class="text-inner">

      <p>Using what we have learned, we are going to put together a simple chat application. We will partially complete the application together, and then you will complete the rest as the assignment.</p>

      <p>Let‚Äôs grab some starting code to start:</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span> 
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN]"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p><code class="language-plaintext highlighter-rouge">chat_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>Let‚Äôs modify our application so that the client can send one message before closing, which will be displayed on the server:</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span> 
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
            <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN]"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p><code class="language-plaintext highlighter-rouge">chat_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>

<span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message_encoded</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span> <span class="p">(</span><span class="s">"enter a message:"</span><span class="p">)</span> 
    <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>However, only sending one message is not particularly useful. We wish to send many messages. Let‚Äôs achieve this using loops. While we are at it, let‚Äôs add a special message which signals we are ready to disconnect. This will be part of our protocol.</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span> 
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="n">connected</span><span class="p">:</span>
                <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN]"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p><code class="language-plaintext highlighter-rouge">chat_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>

<span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message_encoded</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"enter message, or enter '</span><span class="si">{</span><span class="n">DISCONNECT_MESSAGE</span><span class="si">}</span><span class="s">' to diconnect: "</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
        <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
    <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>Hopefully you can see something wrong with this - our in our server we have a nested while loop in the main function. This means once we recieve our first connection, we will be stuck in the inner loop, and unable to accept more connections until the first connection disconnects. One way around this is to use a new thread for each incoming connection on the server.</p>

      <p>We will need one thread to handle each connection, which we will use a threaded function for:</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>

<span class="c1"># one instance of this will run for each client in a thread
</span><span class="k">def</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">connected</span><span class="p">:</span>
        <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">threads</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN]"</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>No changes needed in <code class="language-plaintext highlighter-rouge">chat_client.py</code></p>

      <p>At this stage, we are successfully sending as many messages as we want to the server. However, if we try to shut down our server with <code class="language-plaintext highlighter-rouge">ctrl+c</code>, we still have a thread hanging which will prevent closing. Let‚Äôs try to account for this with a signal. Additionally, we will also need to occasionally stop listening to our connection so that we may check if the signal has been set - we will do this by adding a timeout to our connection, which will raise a socket.timeout error every second, which we may use to return to our while loop condition. Finally, let‚Äôs not forget to join our threads once they complete!</p>

      <p>While we are at it, let‚Äôs also modify the client so that it can alternatively be exited with <code class="language-plaintext highlighter-rouge">ctrl+c</code>.</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>

<span class="c1"># one instance of this will run for each client in a thread
</span><span class="k">def</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">server_active</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">server_active</span><span class="p">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">connected</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">server_active</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">server_active</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">server_active</span><span class="p">))</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">threads</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN] Attempting to close threads."</span><span class="p">)</span>
        <span class="n">server_active</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p><code class="language-plaintext highlighter-rouge">chat_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>

<span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message_encoded</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"enter message, or enter '</span><span class="si">{</span><span class="n">DISCONNECT_MESSAGE</span><span class="si">}</span><span class="s">' to diconnect: "</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
            <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>Try creating a few clients, connect them, and then close the server. The server should close down gracefully. However, we are not notifying the clients that we are shutting down, so they will hang, and unfortunately since <code class="language-plaintext highlighter-rouge">input()</code> is a blocking command, even if they did get the message, they would not be able to handle it. There is no way to handle this in vanilla python, though several libraries exist which could help us, but that is outside the scope of this lab. We will just need to live with this limitation.</p>

      <p>One thing we have been doing so far, which is not great, is the following line:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>What this does is reads every message in the socket buffer up to 1024 bytes. But what if the user wanted to send more than 1024 bytes? We would still have extra message in the buffer after the read, which would be counted as the next transmission. Let‚Äôs experiment by changing this value to 8, and then sending a longer message from the client:</p>

      <p><img src="res/buffer-overrun.png" alt="" /></p>

      <p>To solve this, we need to create a protocol, an agreed set of rules that the server and client will agree to. Let‚Äôs make this such that, whenever we send a message, the first 8 bytes will represent the length of the message (padded to 8 bytes), e.g.</p>

      <p><code class="language-plaintext highlighter-rouge">12      </code></p>

      <p>And then the following transmission will be the message of that length.</p>

      <p><code class="language-plaintext highlighter-rouge">hello world!</code></p>

      <p>Once the user types in the message, we will need to figure out how long that message is, turn it into a byte string, and send that to the server, so that it knows how far to read into the buffer to collect the rest of the message:</p>

      <p><code class="language-plaintext highlighter-rouge">chat_server.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>
<span class="n">HEADER_SIZE_IN_BYTES</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># one instance of this will run for each client in a thread
</span><span class="k">def</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">server_active</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[NEW CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> connected."</span><span class="p">)</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">server_active</span><span class="p">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">connected</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_length_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">HEADER_SIZE_IN_BYTES</span><span class="p">)</span>
            <span class="n">message_length_string</span> <span class="o">=</span> <span class="n">message_length_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message_length_string</span><span class="p">:</span>
                <span class="n">message_length_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">message_length_string</span><span class="p">)</span>
                <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">message_length_int</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message_encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[END CONNECTION] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> disconnected."</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"[STARTING] Server is starting..."</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[LISTENING] Server is listening on </span><span class="si">{</span><span class="n">SERVER_IP</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">server_active</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">server_active</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># this is a blocking command, it will wait for a new connection to the server
</span>            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">server_active</span><span class="p">))</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">threads</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"[SHUTTING DOWN] Attempting to close threads."</span><span class="p">)</span>
        <span class="n">server_active</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">"[ACTIVE CONNECTIONS] </span><span class="si">{</span><span class="n">threading</span><span class="p">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p><code class="language-plaintext highlighter-rouge">chat_client.py</code></p>
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">PC_NAME</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">SERVER_IP</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">PC_NAME</span><span class="p">)</span>
<span class="n">TCP_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="s">'utf-8'</span>
<span class="n">DISCONNECT_MESSAGE</span> <span class="o">=</span> <span class="s">"!Q"</span>
<span class="n">HEADER_SIZE_IN_BYTES</span> <span class="o">=</span> <span class="mi">8</span>

<span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
    <span class="n">message_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_encoded</span><span class="p">)</span>
    <span class="n">message_send_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message_length</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
    <span class="n">padding_needed</span> <span class="o">=</span> <span class="n">HEADER_SIZE_IN_BYTES</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_send_length</span><span class="p">)</span>
    <span class="c1"># this repeats the space byte by
</span>    <span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="s">' '</span> <span class="o">*</span> <span class="n">padding_needed</span>
    <span class="n">padded_message_send_length</span> <span class="o">=</span> <span class="n">message_send_length</span> <span class="o">+</span> <span class="n">padding</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">padded_message_send_length</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message_encoded</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TCP_ADDR</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"enter message, or enter '</span><span class="si">{</span><span class="n">DISCONNECT_MESSAGE</span><span class="si">}</span><span class="s">' to diconnect: "</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">message</span> <span class="o">!=</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">:</span>
            <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">send</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DISCONNECT_MESSAGE</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>      </div>

      <p>We now have a functioning chat client which can send messages of any size up to <code class="language-plaintext highlighter-rouge">99999999</code> characters to the server. In the assignment you will expand this to also be able to send messages to other clients!</p>

      <p>We have covered many things in this lab (maybe too many things?) but hopefully you can see how all these pieces together can create a low level socket-based client-server architecture.</p>

    </div></div></section>
<section id="assignment"><button class="collapsible">Assignment</button><div class="text-content"><div class="text-inner">

      <p>So far, we have successfully made our chat application send information one way, from the user to the server. We will now add some additional features in three phases:</p>

      <p>Phase 1: Echo Service</p>

      <p>An echo service runs on a server, and simply collects any message sent to it, and returns it back to the client. Add this functionality to our application. Be sure to print it out on the client side!</p>

      <p>Hints:</p>
      <ul>
        <li>You may wish to copy some of the send code from the client to the server. However, remember the client only has a single connection, whereas the server has multiple. How will you handle this?</li>
        <li>You may wish to add a thread to the client to handle incoming messages, as the input read code will block code progression in main!
          <ul>
            <li>Be sure to join this thread if the client disconnects before shutting down!</li>
          </ul>
        </li>
      </ul>

      <p>Example output at phase 1:
<img src="res/phase-1-example.png" alt="" /></p>

      <p>Phase 2: Chat Service</p>

      <p>In phase 2, modify the application so that when a client sends a message to the server, it is sent to every other connected client except the one who sent it. The sent message should also contain some identifying information, i.e. which client sent it (address and port).</p>

      <p>Hints:</p>
      <ul>
        <li>Recall we have one thread handling receiving information from each client, but we do not need to use it to send the information back to that client - any thread can use any socket, as long as it knows about it.</li>
        <li>How might you wish to store all of the connections so that they can be accessed by all of the threads?
          <ul>
            <li>How can you prevent against race conditions for these threads?</li>
          </ul>
        </li>
      </ul>

      <p>Note, for this part, please comment out the echo server part, as we no longer wish to send the message back to the user who sent it.</p>

      <p>Example output at phase 2:
<img src="res/phase-2-example.png" alt="" /></p>

      <p>Phase 3: Better Chat</p>

      <p>In the final part, we will polish up our chat application. Upon entry, a client should choose a username, which is sent to the server, and stored as needed. This should be used in chat in place of an address. Additionally, when a user enters or leaves the chat, each other connected client should recieve this information.</p>

      <p>Hint:</p>
      <ul>
        <li>You may wish to have some sort of data structure which associates names and connections.
          <ul>
            <li>If this data structure will be shared among threads, ensure you avoid race conditions!</li>
          </ul>
        </li>
      </ul>

      <p><img src="res/phase-3-examples.png" alt="" /></p>

      <h3 id="submission">Submission</h3>

      <p>You will submit your assignment to URCourses by the due date.</p>

    </div></div></section>
<section id="referencesandresources"><button class="collapsible">References and Resources</button><div class="text-content"><div class="text-inner">

      <p><a href="https://stackoverflow.com/questions/1873214/easiest-daytime-service-client-in-python">Easiest ‚Äúdaytime‚Äù service client in Python? - StackOverflow</a>, [Online]</p>

      <p><a href="https://www.bogotobogo.com/python/python_network_programming_server_client.php">Python Tutorial: Network Programming - Server &amp; Client A: Basics - 2020</a>, [Online]</p>

      <p><a href="https://www.geeksforgeeks.org/multithreading-python-set-1/">Multithreading in Python</a>, [Online]</p>

      <p><a href="https://stackoverflow.com/questions/11436502/closing-all-threads-with-a-keyboard-interrupt">Closing all threads with a keyboard interrupt</a> [Online]</p>

      <p>Tech with Tim. <a href="https://www.youtube.com/watch?v=3QiPPX-KeSc">Python Socket Programming Tutorial</a> [Online]. (Note - I based my chat application off of this tutorial. There are some errors with him Network descriptions though!)</p>
    </div></div></section>

    </main>

  </div>
  <footer>
    2022 Adam Tilson.
    <a href="https://creativecommons.org/licenses/by-nc-sa/2.0/"
      >CC-BY-NC-SA</a
    >
  </footer>
  <button onclick="topFunction()" id="topButton" title="Go to top">‚ñ≤ Top</button> 
  <script src="/assets/js/script.js"></script>

</body>
</html>
